<!DOCTYPE html>
<html lang="en">
<head>
<title>用户中心</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<meta name="keywords" content="" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
<!-- bootstrap-css -->
<link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
<!--// bootstrap-css -->
<!-- css -->
<link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
<!--// css -->
<!-- font-awesome icons -->
<link href="css/font-awesome.css" rel="stylesheet"> 
<!-- //font-awesome icons -->
<!-- font -->
<!--<link href="http://fonts.googleapis.com/css?family=Playball&amp;subset=latin-ext" rel="stylesheet">
<link href="http://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700italic,700,400italic,300italic,300' rel='stylesheet' type='text/css'>-->
<!-- //font -->
<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/check.js"></script>
<script type="text/javascript">
	jQuery(document).ready(function($) {
		$(".scroll").click(function(event){		
			event.preventDefault();
			$('html,body').animate({scrollTop:$(this.hash).offset().top},1000);
		});
	});
</script> 
<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
<![endif]-->
</head>
<body>
	<!-- banner -->
	<div class="banner about-banner">
		<div class="header">
			<div class="container">
				<div class="header-left">
					<div class="w3layouts-logo">
						<h1>
							<a href="index.html">每日鲜 <span><sup>Life</sup></span></a>
						</h1>
					</div>
				</div>
				<div class="clearfix"> </div>
			</div>
		</div>
		<div class="header-bottom">
			<div class="container">
				<div class="top-nav">
					<nav class="navbar navbar-default">
							<div class="navbar-header">
								<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
									<span class="sr-only">Toggle navigation</span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
							</div>
						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
							<ul class="nav navbar-nav">
								<li><a class="active list-border" href="index.html">主页</a></li>
								<li><a href="goodsList.html">生鲜列表</a></li>
								<li class=""><a href="#" class="dropdown-toggle hvr-bounce-to-bottom" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">分类<span class="caret"></span></a>
									<ul class="dropdown-menu">
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=1">水果</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=2">肉类</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=3">蔬菜</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=4">水产</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=5">乳品</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=6">酒饮</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=7">熟食</a></li>
										<li><a class="hvr-bounce-to-bottom" href="goodsList.html?type=8">轻食</a></li>
									</ul>
								</li>								
								<li><a href="cart.html">购物车</a></li>
								<li><a class="list-border1" href="userInfo.html">个人中心</a></li>
								<li><a class="list-border1" href="order.html">订单配送</a></li>
							</ul>	
							<div class="clearfix"> </div>
						</div>	
					</nav>	
				</div>
			</div>
		</div>
	</div>
	<!-- //banner -->
	<div class="about-heading">	
		<div class="container">
			<h2>购物车</h2>
		</div>
	</div>
	<!-- contact -->
	<div class="contact">
		<div class="container">
			<p class="wow fadeInUp animated" data-wow-delay=".5s">Add fresh and go pay to the OrderInfo.</p>
				<div class="bs-docs-example wow fadeInUp animated" data-wow-delay=".5s">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>生鲜</th>
								<th>预览</th>
								<th>数量</th>
								<th>单价</th>
								<th>总价</th>
								<th>库存</th>
								<th style="width: 20%">操作</th>
							</tr>
						</thead>
						<tbody id="cartList">
						</tbody>
					</table>
				</div>			
		</div>
	</div>
	<!-- //contact -->
	<div class="blog" style="margin:0px;padding: 0px;margin-bottom: 20px;">
		<div class="container">
			<div class="agile-blog-grids">
				<div class="col-md-8 agile-blog-grid-left"  style="width: 100%;float: left;">
					<p style="clear:both"></p>
					<nav>
						<ul class="pagination"  style="margin:0px;padding: 0px;float: right;">
							<input type="hidden" id="counts" />
							<li>
								<a onclick="upPage()" aria-label="Previous">
									<span  aria-hidden="true">«</span>
								</a>
							</li>
							<li><a href="#" id="pages">1</a></li>
							<li><a href="#" > / </a></li> 
							<li><a href="#" id="pageCounts">1</a></li>
							<li>
								<a onclick="nextPage()" aria-label="Next">
									<span  aria-hidden="true">»</span>
								</a> 
							</li>
						</ul>
					</nav>
				</div>
				<div class="clearfix"> </div> 
			</div>
		</div>
	</div>
	
	<script src="js/SmoothScroll.min.js"></script>
	<script type="text/javascript" src="js/move-top.js"></script>
	<script type="text/javascript" src="js/easing.js"></script>
	<!-- here stars scrolling icon -->
	<script type="text/javascript">
	
	$(document).ready(function() {
		var id="";
		if (getCookie("mrxuserId") == null) {
	        alert("检测到账户未登录!");
	        window.location.href = "login.html";
	    }else{
	    	id=getCookie("mrxuserId");
	    	getAll("");
			getCounts();
			$().UItoTop({ easingType: 'easeOutQuart' });
	    }
	});
	
	function getAll(url){
		var id="";
		if (getCookie("mrxuserId") == null) {
	        alert("检测到账户未登录!");
	        window.location.href = "login.html";
	    }else{
	    	id=getCookie("mrxuserId");
	    }
		if(url==""||null==url){
			url="/cart/getByUser?page=1&rows=10&id="+id;
		}else{
			url=url+"&id="+id;
		}
		$.ajax({
			type:"post",
			url:url,
			async:false,
			success:function(result){
				var name="";
				var price=0;
				var priceSum=0;
				var nums=0;
				var inventory="";
				var goodsPic="";
				for(var i=0;i<result.length;i++){
					name=getGoodsName(result[i].goodsid);
					price=getGoodsPrices(result[i].goodsid)*1;
					inventory=getGoodsKC(result[i].goodsid);
					goodsPic=getGoodsPic(result[i].goodsid);
					nums=result[i].num*1;
					priceSum=price*nums*1.0;
					var html=`<tr>
						<td>${name}</td>
						<td><img width="60" height="50" src=${goodsPic}>
						<td>${nums}</td>
						<td>${price}</td>
						<td>${priceSum}</td>
						<td>${inventory}</td>
						<td>
							<a href="goodsInfo.html?id=${result[i].goodsid}" style="padding: 8px;" class="label label-info">商品详情 </a> &nbsp;
							<a href="pay.html?id=${result[i].id}" style="padding: 8px;" class="label label-success"> 直接购买 </a> &nbsp;
							<a onclick="deleteCart(${result[i].id})" style="padding: 8px;" class="label label-danger">删除   </a>
						</td>
					</tr>`;
					//alert(html);
					$("#cartList").append(html);
				}
			}
		});
	}
	function getGoodsPic(id){
		var pic_url="";
		$.ajax({
            type: "GET",
            dataType: "json",
            async:false,
            url: '/goods/info/' + id,
            success: function (data) {
                if (data != null) {
                	pic_url=data.data.pic_url;
                }else {
                    alert(" getGoodsPic data.data.pic_url 无数据!");
                }
            }
        });
		return pic_url;
	 }
	
	function getCounts(){
		var id="";
		if (getCookie("mrxuserId") == null) {
	        alert("检测到账户未登录!");
	        window.location.href = "login.html";
	    }else{
	    	id=getCookie("mrxuserId");
	    }
		url="/cart/countByUser?id="+id;
		/*查询管理员信息*/
		$.ajax({
			type:"get",
			url:url,
			async:false,
			success:function(result){
				console.log("result"+result);
				console.log("result.total"+result.total);
				$("#counts").text(result.total);
				$("#counts").val(result.total);
				var size=10*1;
				var counts=result.total*1;
				var endPages=Math.ceil(counts/size);
				$("#pageCounts").text(endPages);
			}
		});
	}
	
	function backPage(){
		$("#pages").text("1");
		getAll("");
	}
	
	function upPage(){
		$("#cartList").html("");
		var pageNow=$("#pages").text();
		var pageN= pageNow*1-1;
		if(pageN>0){
			$("#pages").text(pageN);
			getAll("/cart/getByUser?page="+pageN+"&rows=10");
		}else{
			alert("当前是第一页");
			getAll("/cart/getByUser?page="+pageNow+"&rows=10");
			return;
		}
	}
	
	function nextPage(){
		$("#cartList").html("");
		var pageNow=$("#pages").text();
		var pageN= pageNow*1+1;
		var size=10*1;
		var counts=$("#counts").text()*1;
		var endPages=Math.ceil(counts/size);
		if(pageN<=endPages){
			$("#pages").text(pageN);
			getAll("/cart/getByUser?page="+pageN+"&rows=10");
		}else{
			alert("当前已是最后一页");
			getAll("/cart/getByUser?page="+pageNow+"&rows=10");
			return;
		}
	}
	
	function deleteCart(id){
		 if(confirm("确定删除么？"))
		 {
			 $.ajax({
		            type: "GET",//方法类型
		            dataType: "json",//预期服务器返回的数据类型
		            url: "/cart/delete/" + id,//url
		            success: function (result) {
		                console.log(result);//打印服务端返回的数据
		                if (result.resultCode == 200) {
		                    //alert("数据已成功删除！");
		                }else {
		                	alert("删除失败");
		                }
		            },
		            error: function () {
		            	alert("ERROR！");
		            }
		        });
		    	location.reload();
		 }
	 	}
	
		function getGoodsName(id){
			var name="";
			$.ajax({
	            type: "GET",
	            dataType: "json",
	            async:false,
	            url: '/goods/info/' + id,
	            success: function (data) {
	            	if(data.resultCode==200){
	            		name=data.data.goodsname;
	            	}else{
	            		name="商品已不存在,请删除！";
	            	}
	            },
	            error:function (e) {
	            	name="商品已不存在";
	            }
	        });
			return name;
   	 	}
	
		function getGoodsPrices(id){
			var price="";
			$.ajax({
	            type: "GET",
	            dataType: "json",
	            async:false,
	            url: '/goods/info/' + id,
	            success: function (data) {
	            	if(data.resultCode==200){
	            		price=data.data.price;
	            	}else{
	            		price="商品已不存在";
	            	}
	            }
	        });
			return price;
   	 	}
		function getGoodsKC(id){
			var inventory="";
			$.ajax({
	            type: "GET",
	            dataType: "json",
	            async:false,
	            url: '/goods/info/' + id,
	            success: function (data) {
	            	if(data.resultCode==200){
	            		inventory=data.data.inventory;
	            	}else{
	            		inventory="商品已不存在";
	            	}
	            }
	        });
			return inventory;
   	 	}

	</script>
	<!-- //here ends scrolling icon -->
</body>	
</html>